"use strict";(self.webpackChunkjanstarke_blog=self.webpackChunkjanstarke_blog||[]).push([[1379],{7676:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>r,default:()=>h,frontMatter:()=>o,metadata:()=>i,toc:()=>d});var a=n(5893),s=n(1151);const o={title:"Invalid TCP segments created by macof",date:"2015-02-01",categories:["allgemein","pentest"],layout:"post",authors:["jasa"]},r=void 0,i={permalink:"/blog/2015/02/01/invalid-tcp-segments-created-by-macof",source:"@site/blog/2015-02-01-invalid-tcp-segments-created-by-macof.mdx",title:"Invalid TCP segments created by macof",description:"Some days ago, we used the tool macof, which is part of the dsniff package, in one penetration test. We observed that our attack had no effect to the hosts in the network, so we started sniffing around. Wireshark was our friend.",date:"2015-02-01T00:00:00.000Z",tags:[],readingTime:1.575,hasTruncateMarker:!1,authors:[{name:"Jan Starke",title:"Senior Forensic Analyst",url:"https://github.com/janstarke",imageURL:"https://github.com/janstarke.png",key:"jasa"}],frontMatter:{title:"Invalid TCP segments created by macof",date:"2015-02-01",categories:["allgemein","pentest"],layout:"post",authors:["jasa"]},unlisted:!1,prevItem:{title:"Measuring Forensic Readiness",permalink:"/blog/2015/02/02/measuring-forensic-readiness"},nextItem:{title:"Userspace tool for (anti-forensically safe) wiping unallocated disk space",permalink:"/blog/2014/02/20/userspace-tool-for-wiping-unallocated-disk-space"}},c={authorsImageUrls:[void 0]},d=[];function l(e){const t={a:"a",code:"code",em:"em",p:"p",pre:"pre",...(0,s.a)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(t.p,{children:["Some days ago, we used the tool ",(0,a.jsx)(t.em,{children:"macof"}),", which is part of the ",(0,a.jsx)(t.a,{href:"http://www.monkey.org/~dugsong/dsniff/",title:"dsniff",children:"dsniff"})," package, in one penetration test. We observed that our attack had no effect to the hosts in the network, so we started sniffing around. Wireshark was our friend."]}),"\n",(0,a.jsxs)(t.p,{children:["Wireshark identified our packets, generated by ",(0,a.jsx)(t.em,{children:"macof"}),', as "invalid". It took some time for us to realize that IP Header value for ',(0,a.jsx)(t.em,{children:"Total Length"})," was indeed wrong! We used ",(0,a.jsx)(t.em,{children:"macof"})," to send TCP SYN segments to some specific port, so ",(0,a.jsx)(t.em,{children:"Total Length"})," should be 40 (20 Byte IP Header + 20 Byte TCP Header), but macos generated packets with a value of 20."]}),"\n",(0,a.jsx)(t.p,{children:"So we started a little code reading session and found the following statements in macof.c:"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-c",children:"libnet_build_tcp(sport, dport, seq, 0, TH_SYN, 512, 0, 0, LIBNET_TCP_H, NULL, 0, l, 0);\n\nlibnet_build_ipv4(LIBNET_TCP_H, 0, libnet_get_prand(LIBNET_PRu16), 0, 64, IPPROTO_TCP, 0, src, dst, NULL, 0, l, 0);\n"})}),"\n",(0,a.jsx)(t.p,{children:"Obviously, the length of the IP Header is not included in this calculation. We changed the above statements to"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-c",children:"libnet_build_tcp(sport, dport, seq, 0, TH_SYN, 512, 0, 0, LIBNET_TCP_H, NULL, 0, l, 0);\n\nlibnet_build_ipv4(LIBNET_IPV4_H+LIBNET_TCP_H, 0, libnet_get_prand(LIBNET_PRu16), 0, 64, IPPROTO_TCP, 0, src, dst, NULL, 0, l, 0);\n"})}),"\n",(0,a.jsx)(t.p,{children:"with the result, that Wireshark didn't complain about our packets anymore."}),"\n",(0,a.jsx)(t.p,{children:"And, more important, our attack did work now :-)"}),"\n",(0,a.jsx)(t.p,{children:"After the test, I sent an email to the author of macof and dsniff, including a patch of what we've done, but until today I received no answer. So, I'll publsh our patch here, and you are free to use it:"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-shell",children:"\xa0diff -rupN dsniff-2.4_beta1-r6/macof.c dsniff-2.4_beta1-r6_FIX/macof.c\n"})}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-diff",children:"--- dsniff-2.4_beta1-r6/macof.c\t2015-01-20 08:50:53.980054279 +0100\n+++ dsniff-2.4_beta1-r6_FIX/macof.c\t2015-01-20 08:51:24.220054894 +0100\n@@ -134,7 +134,7 @@ main(int argc, char *argv[])\n \t\tlibnet_build_tcp(sport, dport, seq, 0, TH_SYN, 512,\n \t\t\t\t 0, 0, LIBNET_TCP_H, NULL, 0, l, 0);\n \t\t\n-\t\tlibnet_build_ipv4(LIBNET_TCP_H, 0,\n+\t\tlibnet_build_ipv4(LIBNET_IPV4_H + LIBNET_TCP_H, 0,\n \t\t\t\t  libnet_get_prand(LIBNET_PRu16), 0, 64,\n \t\t\t\t  IPPROTO_TCP, 0, src, dst, NULL, 0, l, 0);\n"})})]})}function h(e={}){const{wrapper:t}={...(0,s.a)(),...e.components};return t?(0,a.jsx)(t,{...e,children:(0,a.jsx)(l,{...e})}):l(e)}},1151:(e,t,n)=>{n.d(t,{Z:()=>i,a:()=>r});var a=n(7294);const s={},o=a.createContext(s);function r(e){const t=a.useContext(o);return a.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function i(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),a.createElement(o.Provider,{value:t},e.children)}}}]);