"use strict";(self.webpackChunkjanstarke_blog=self.webpackChunkjanstarke_blog||[]).push([[3616],{3480:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>i,default:()=>a,frontMatter:()=>r,metadata:()=>l,toc:()=>h});var s=n(5893),d=n(1151);const r={layout:"post",title:"Forensic analysis of deleted `$MFT` entries",date:new Date("2021-10-22T00:00:00.000Z"),categories:"forensics",authors:["jasa"]},i="Why is this important?",l={permalink:"/blog/2021/10/22/mft_entry_sequence",source:"@site/blog/2021-10-22-mft_entry_sequence.mdx",title:"Forensic analysis of deleted `$MFT` entries",description:'In the book FILE SYSTEM FORENSIC ANALYSIS, the author Brian Carrier states that "Every MFT entry also has a 16-bit sequence numberthat is incremented when the entry is allocated. For example, consider MFT entry 313 with a sequence number of 1. The file that allocated entry 313 is deleted, and the entry is allocated to a new file. When the entry is reallocated, it has a new sequence number of 2." (page 276).',date:"2021-10-22T00:00:00.000Z",tags:[],readingTime:2.235,hasTruncateMarker:!1,authors:[{name:"Jan Starke",title:"Senior Forensic Analyst",url:"https://github.com/janstarke",imageURL:"https://github.com/janstarke.png",key:"jasa"}],frontMatter:{layout:"post",title:"Forensic analysis of deleted `$MFT` entries",date:"2021-10-22T00:00:00.000Z",categories:"forensics",authors:["jasa"]},unlisted:!1,prevItem:{title:"Using regripper on MacOS",permalink:"/blog/2021/11/02/Using-regripper-on-darwin"},nextItem:{title:"$MFT file parser improved",permalink:"/blog/2021/10/17/mft2bodyfile2"}},c={authorsImageUrls:[void 0]},h=[{value:"Test setup",id:"test-setup",level:2},{value:"Results",id:"results",level:2}];function o(e){const t={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",li:"li",p:"p",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,d.a)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(t.p,{children:["In the book ",(0,s.jsx)(t.em,{children:"FILE SYSTEM FORENSIC ANALYSIS"}),", the author ",(0,s.jsx)(t.em,{children:"Brian Carrier"})," states that ",(0,s.jsx)(t.em,{children:'"Every MFT entry also has a 16-bit sequence numberthat is incremented when the entry is allocated. For example, consider MFT entry 313 with a sequence number of 1. The file that allocated entry 313 is deleted, and the entry is allocated to a new file. When the entry is reallocated, it has a new sequence number of 2."'})," (page 276)."]}),"\n",(0,s.jsxs)(t.p,{children:["I think this i partially wrong. Let's see what Microsoft is saying: ",(0,s.jsx)(t.em,{children:'"The sequence number. This value is incremented each time that a file record segment is freed; it is 0 if the segment is not used. The SequenceNumber field of a file reference must match the contents of this field; if they do not match, the file reference is incorrect and probably obsolete."'})," (",(0,s.jsx)(t.a,{href:"https://docs.microsoft.com/en-us/windows/win32/devnotes/file-record-segment-header",children:"https://docs.microsoft.com/en-us/windows/win32/devnotes/file-record-segment-header"}),")"]}),"\n",(0,s.jsxs)(t.p,{children:["This information is crucial when you found a file which has been content of some deleted folder. To retrieve the folders name, you need to find its ",(0,s.jsx)(t.code,{children:"$FILE_NAME"})," information. So, you take the ",(0,s.jsx)(t.code,{children:"parent"})," field from the ",(0,s.jsx)(t.code,{children:"$FILE_NAME"}),"attribute of the deleted file. Let's assume this is ",(0,s.jsx)(t.code,{children:"313-1"})," (where ",(0,s.jsx)(t.code,{children:"313"})," is the parent entry number and ",(0,s.jsx)(t.code,{children:"1"})," is its sequence number). Further, let's assume that this parent has been deleted, but the MFT entry was not reallocated:"]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["If the sequence number was incremented upon reallocated, it would still be ",(0,s.jsx)(t.code,{children:"1"})]}),"\n",(0,s.jsxs)(t.li,{children:["Otherwise, if the sequence number was incremented when deleting the folder, it would be ",(0,s.jsx)(t.code,{children:"2"})," now."]}),"\n"]}),"\n",(0,s.jsxs)(t.p,{children:["But how can we be sure that we can use the ",(0,s.jsx)(t.code,{children:"$FILE_NAME"})," of ",(0,s.jsx)(t.code,{children:"313-2"}),", if the deleted file refered to ",(0,s.jsx)(t.code,{children:"313-1"}),"?"]}),"\n",(0,s.jsx)(t.h1,{id:"lets-test-what-happens",children:"Let's test what happens."}),"\n",(0,s.jsx)(t.h2,{id:"test-setup",children:"Test setup"}),"\n",(0,s.jsx)(t.p,{children:"I created a NTFS partition using Windows 8, and created three folders:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.code,{children:"bulk delete"})}),"\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.code,{children:"single delete"})}),"\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.code,{children:"mixed delete"})}),"\n"]}),"\n",(0,s.jsxs)(t.p,{children:["Each folder had two files: ",(0,s.jsx)(t.code,{children:"sample1.rtf"})," and ",(0,s.jsx)(t.code,{children:"samples.rtf"}),". Than I did the following:"]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["delete ",(0,s.jsx)(t.code,{children:"bulk delete"})," with all its contents"]}),"\n",(0,s.jsxs)(t.li,{children:["delete ",(0,s.jsx)(t.code,{children:"mixed delete/sample2.rtf"})]}),"\n",(0,s.jsxs)(t.li,{children:["delete ",(0,s.jsx)(t.code,{children:"mixed delete"})," with all of its contents (",(0,s.jsx)(t.code,{children:"sample1.rtf"}),")"]}),"\n",(0,s.jsxs)(t.li,{children:["delete ",(0,s.jsx)(t.code,{children:"single delete/sample1.rtf"})]}),"\n",(0,s.jsxs)(t.li,{children:["delete ",(0,s.jsx)(t.code,{children:"single delete/sample2.rtf"})]}),"\n",(0,s.jsxs)(t.li,{children:["delete ",(0,s.jsx)(t.code,{children:"single delete"})," with all of its contents (none)"]}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"results",children:"Results"}),"\n",(0,s.jsx)(t.p,{children:"After deletion, I found the following MFT references"}),"\n",(0,s.jsxs)(t.table,{children:[(0,s.jsx)(t.thead,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.th,{children:"Name"}),(0,s.jsx)(t.th,{children:"Entry #"}),(0,s.jsx)(t.th,{children:"Parent entry #"})]})}),(0,s.jsxs)(t.tbody,{children:[(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"bulk delete"})}),(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"37-2"})}),(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"5-5"})})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"bulk delete/sample1.rtf"})}),(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"43-2"})}),(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"37-1"})})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"bulk delete/sample2.rtf"})}),(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"44-2"})}),(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"37-1"})})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"single delete"})}),(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"41-2"})}),(0,s.jsx)(t.td,{})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"single delete/sample1.rtf"})}),(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"47-2"})}),(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"41-1"})})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"single delete/sample2.rtf"})}),(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"48-2"})}),(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"41-1"})})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"mixed delete"})}),(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"42-2"})}),(0,s.jsx)(t.td,{})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"mixed delete/sample1.rtf"})}),(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"45-1"})}),(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"42-1"})})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"mixed delete/sample2.rtf"})}),(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"46-1"})}),(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"42-1"})})]})]})]}),"\n",(0,s.jsxs)(t.p,{children:["Obviously, our test shows that sequence numbers are incremented right after deletion, but ",(0,s.jsx)(t.em,{children:"not"})," nessecarily at reallocation. The Microsoft documentation is right."]})]})}function a(e={}){const{wrapper:t}={...(0,d.a)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(o,{...e})}):o(e)}},1151:(e,t,n)=>{n.d(t,{Z:()=>l,a:()=>i});var s=n(7294);const d={},r=s.createContext(d);function i(e){const t=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function l(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(d):e.components||d:i(e.components),s.createElement(r.Provider,{value:t},e.children)}}}]);