"use strict";(self.webpackChunkjanstarke_blog=self.webpackChunkjanstarke_blog||[]).push([[9832],{7177:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>d,default:()=>o,frontMatter:()=>t,metadata:()=>c,toc:()=>h});var s=i(4848),r=i(8453);const t={layout:"page",title:"Forensische Analyse von Active Directory Datenbanken"},d="Digitale Forensik: Analyse von Active Directory Datenbanken",c={id:"forensics/ad_forensics",title:"Forensische Analyse von Active Directory Datenbanken",description:"Viele komplexe Angriffe gegen Unternehmensnetzwerke finden in mehreren Phasen statt:",source:"@site/docs/02_forensics/ad_forensics.md",sourceDirName:"02_forensics",slug:"/forensics/ad_forensics",permalink:"/forensics/ad_forensics",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{layout:"page",title:"Forensische Analyse von Active Directory Datenbanken"},sidebar:"tutorialSidebar",previous:{title:"Forensics",permalink:"/category/forensics"},next:{title:"Forensic snippets for me and you",permalink:"/forensics/snippets"}},l={},h=[{value:"Spurensicherung",id:"spurensicherung",level:2},{value:"Daten in der <code>ntds.dit</code>",id:"daten-in-der-ntdsdit",level:2},{value:"Abk\xfcrzungen",id:"abk\xfcrzungen",level:2},{value:"Quellen",id:"quellen",level:2}];function a(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",li:"li",ol:"ol",p:"p",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"digitale-forensik-analyse-von-active-directory-datenbanken",children:"Digitale Forensik: Analyse von Active Directory Datenbanken"}),"\n",(0,s.jsx)(n.p,{children:"Viele komplexe Angriffe gegen Unternehmensnetzwerke finden in mehreren Phasen statt:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Informationsgewinnung"}),"\n",(0,s.jsx)(n.li,{children:"Initialer Zugriff: bspw. Ausnutzen einer Schwachstelle in einer Software"}),"\n",(0,s.jsx)(n.li,{children:"Persistenz: Sicherstellen, dass ein sp\xe4terer Zugriff auf das System m\xf6glich ist, auch wenn bspw. die ausgenutzte Schwachstelle geschlossen wurde"}),"\n",(0,s.jsx)(n.li,{children:"Rechteausweitung: \xdcbernahme eines Benutzerkontos mit weitergehenden Rechten"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"und so weiter..."}),"\n",(0,s.jsxs)(n.p,{children:["Die Benutzerkonten, Passw\xf6rter, Berechtigungen etc. werden in den meisten Unternehmensnetzwerken in einem Active Directory (",(0,s.jsx)(n.a,{href:"#AD",children:"AD"}),") verwaltet. Deswegen ist das ",(0,s.jsx)(n.a,{href:"#AD",children:"AD"})," ein f\xfcr Angreifer interessantes Mittel sowohl f\xfcr Persistenz als auch f\xfcr die Rechteausweitung. Dazu sind aktuell folgende Optionen bekannt:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"versteckte Benutzerkonten unter der Kontrolle des Angreifers"}),"\n",(0,s.jsx)(n.li,{children:"privilegierte Mitgliedschaften von Benutzerkonten, die eigentlich wenig Rechte haben sollten"}),"\n",(0,s.jsx)(n.li,{children:"privilegierte Computerkonten unter der Kontrolle des Angreifers"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Au\xdferdem hinterlassen viele Angriffe auch unbeabsichtigt Spuren im Active Directory, die bei der Analyse genutzt werden k\xf6nnen, bspw. neu angelegte Computerkonten."}),"\n",(0,s.jsxs)(n.p,{children:["Ziel des Artikels ist, Grundz\xfcge der forensischen Analyse von ",(0,s.jsx)(n.a,{href:"#AD",children:"AD"}),"-Datenbanken zu vermitteln. Es wird zun\xe4chst beschrieben, wie die ",(0,s.jsx)(n.a,{href:"#AD",children:"AD"}),"-Datenbank aufgebaut ist, und was bei der forensischen Sicherung zu beachten ist. Abschlie\xdfend wird gezeigt, wie man eine forensische Analyse einer ",(0,s.jsx)(n.a,{href:"#AD",children:"AD"}),"-Datenbank mit ",(0,s.jsx)(n.code,{children:"ntdsextract2"})," ",(0,s.jsx)(n.a,{href:"#a1",children:"[1]"})," durchf\xfchren kann. Um das m\xf6glichst einfach anschaulich zu gestalten, wurde eine einfache ",(0,s.jsx)(n.a,{href:"#AD",children:"AD"}),"-Datenbank verwendet. In dieser Datenbank sind keine konkreten Angriffsspuren zu finden; der Artikel besch\xe4ftigt sich ausschlie\xdflich mit der Vorgehensweise bei der forensischen Arbeit; jedoch nicht mit konkreten Angriffsmethoden."]}),"\n",(0,s.jsx)(n.h2,{id:"spurensicherung",children:"Spurensicherung"}),"\n",(0,s.jsxs)(n.p,{children:["Wir haben von einem Domain Controller des angegriffenen Netzwerks die Datei ",(0,s.jsx)(n.code,{children:"%windir%\\NTDS\\ntds"}),".dit gesichert. Diese Datei ist eine Jet-Datenbank, in der die ",(0,s.jsx)(n.a,{href:"#AD",children:"AD"}),"-Objekte gespeichert sind. Au\xdferdem haben wir alle Log-Dateien mit gesichert. Es besteht die M\xf6glichkeit, dass einige Inhalte noch nicht in die ",(0,s.jsx)(n.code,{children:"ntds.dit"})," zur\xfcckgeschrieben wurden. Wir m\xfcssen also in der Lage sein, eine vollst\xe4ndig synchrone Variante der ",(0,s.jsx)(n.a,{href:"#AD",children:"AD"}),"-Datenbank zu schreiben. In Summe haben wir folgende Dateien gesichert:"]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Datei"}),(0,s.jsx)(n.th,{children:"Beschreibung"}),(0,s.jsx)(n.th,{children:"Wichtig f\xfcr Forensik?"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ntds.dit"})}),(0,s.jsx)(n.td,{children:"AD Datenbank"}),(0,s.jsx)(n.td,{children:"\u2714\ufe0f"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"edb.log"})}),(0,s.jsx)(n.td,{children:"Transaction-Log f\xfcr ntds.dit"}),(0,s.jsx)(n.td,{children:"\u2714\ufe0f"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"edbxxxxx.log"})}),(0,s.jsxs)(n.td,{children:["Zus\xe4tzliche Transaction-Log-Dateien. Diese werden geschrieben, wenn ",(0,s.jsx)(n.code,{children:"edb.log"})," voll ist, bevor die Logs in die ",(0,s.jsx)(n.code,{children:"ntds.dit"})," zur\xfcckgeschrieben werden"]}),(0,s.jsx)(n.td,{children:"\u2714\ufe0f"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"res1.log"})," und ",(0,s.jsx)(n.code,{children:"res2.log"})]}),(0,s.jsxs)(n.td,{children:["Reserve-Logdateien. Diese enthalten keine Daten (theoretisch), sondern blockieren nur Speicherplatz. Wenn der Plattenplatz knapp wird, dann wird Speicherplatz dieser beiden Dateien genutzt, um die ",(0,s.jsx)(n.code,{children:"edbxxxxx.log"})," schreiben zu k\xf6nnen."]}),(0,s.jsx)(n.td,{children:"\u274c"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"temp.ed"})}),(0,s.jsxs)(n.td,{children:['"Notizblock" f\xfcr die Arbeit mit der ',(0,s.jsx)(n.code,{children:"ntds.dit"})]}),(0,s.jsx)(n.td,{children:"\u274c"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"schema.ini"})}),(0,s.jsxs)(n.td,{children:["Schemabeschreibung f\xfcr die initiale Einrichtung des ",(0,s.jsx)(n.a,{href:"#AD",children:"AD"})," Schema"]}),(0,s.jsx)(n.td,{children:"\u274c"})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:["Sollte sich herausstellen, dass die ",(0,s.jsx)(n.code,{children:"ntds.dit"})," nicht sauber ist, oder dass Informationen fehlen, dann m\xfcssen die Informationen in den Transaction-Logs zur\xfcckgespielt werden. Daf\xfcr wird das Programm ",(0,s.jsx)(n.code,{children:"esentutl"})," genutzt; aber das ist nicht Thema dieses Artikels."]}),"\n",(0,s.jsx)(n.admonition,{type:"info",children:(0,s.jsxs)(n.p,{children:["F\xfcr diesen Artikel habe eine \xf6ffentliche ",(0,s.jsx)(n.a,{href:"#AD",children:"AD"})," Datenbank von Didier Stevens ",(0,s.jsx)(n.a,{href:"#a2",children:"[2]"})," genutzt, die speziell f\xfcr Lernzwecke zur Verf\xfcgung gestellt wurde."]})}),"\n",(0,s.jsxs)(n.h2,{id:"daten-in-der-ntdsdit",children:["Daten in der ",(0,s.jsx)(n.code,{children:"ntds.dit"})]}),"\n",(0,s.jsxs)(n.p,{children:["Die Datei ",(0,s.jsx)(n.code,{children:"ntds.dit"})," enth\xe4lt \u2014 technisch gesehen \u2014 zun\xe4chst einmal eine EseDB-Datenbank (Extensible Storage Engine) mit mehreren Tabellen. Die Daten des Active Directory liegen in der Tabelle datatable; viele Verkn\xfcpfungen zwischen Objekten, bspw. Gruppenmitgliedschaften, sind in der Tabelle ",(0,s.jsx)(n.code,{children:"link_table"})," gespeichert."]}),"\n",(0,s.jsxs)(n.p,{children:["Jedes ",(0,s.jsx)(n.a,{href:"#AD",children:"AD"}),"-Objekt entspricht einer Zeile (engl. ",(0,s.jsx)(n.code,{children:"row"}),") der Tabelle ",(0,s.jsx)(n.code,{children:"datatable"}),". Diese Tabelle hat eine Vielzahl von Spalten, je nachdem, wie genau das Schema des ",(0,s.jsx)(n.a,{href:"#AD",children:"AD"})," aussieht. F\xfcr jedes Attribut eines ",(0,s.jsx)(n.a,{href:"#AD",children:"AD"}),"-Objekts existiert eine Spalte. Der Datentyp der Spalte sowie die Interpretation des Wertes obliegt dem Programm, das den Wert ausliest. Angenommen, wir wollen herausfinden, ob ein Account abgelaufen ist. Dann m\xfcssen wir folgende Schritte durchf\xfchren"]}),"\n",(0,s.jsxs)(n.p,{children:["Wir ermitteln die Spalte mit dem Namen ",(0,s.jsx)(n.code,{children:"ATTq589983"})," und lesen den Wert aus"]}),"\n",(0,s.jsxs)(n.p,{children:["Der Wert in der Spalte ist (im Beispiel) ",(0,s.jsx)(n.code,{children:"9223372036854775807"}),", mit dem Datentyp ",(0,s.jsx)(n.code,{children:"Currency"})," (W\xe4hrung). Nat\xfcrlich handelt es sich nicht um Geld, sondern einfach um eine 64 Bit gro\xdfe Zahl, die die Anzahl der 100 Nanosekunden seit 01.01.1601 angibt ",(0,s.jsx)(n.a,{href:"#a3",children:"[3]"}),", und zwar in ",(0,s.jsx)(n.a,{href:"#UTC",children:"UTC"}),". Diese Zahl entspricht dem Zeitstempel ",(0,s.jsx)(n.code,{children:"9999-12-31T23:59:59+0000"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["Theoretisch. Tats\xe4chlich ist diese Zahl auch gleichzeitig die gr\xf6\xdfte Zahl, die als 64 Bit mit Vorzeichen darstellbar ist. Microsoft hat diesen Wert vorgesehen, um zu speichern, dass ein Account nie abl\xe4uft ",(0,s.jsx)(n.a,{href:"#a4",children:"[4]"}),"."]}),"\n",(0,s.jsx)(n.p,{children:"Die Antwort ist also: Der Account ist nicht abgelaufen."}),"\n",(0,s.jsx)(n.h2,{id:"abk\xfcrzungen",children:"Abk\xfcrzungen"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{}),(0,s.jsx)(n.th,{})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)("a",{id:"AD",children:"AD"})}),(0,s.jsx)(n.td,{children:"Active Directory"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)("a",{id:"UTC",children:"UTC"})}),(0,s.jsx)(n.td,{children:"Universal Time Coordinated"})]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"quellen",children:"Quellen"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{}),(0,s.jsx)(n.th,{})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)("a",{id:"a1",children:"[1]"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.a,{href:"https://github.com/janstarke/ntdsextract2",children:"https://github.com/janstarke/ntdsextract2"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)("a",{id:"a2",children:"[2]"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.a,{href:"https://blog.didierstevens.com/2016/07/12/practice-ntds-dit-file-part-1",children:"https://blog.didierstevens.com/2016/07/12/practice-ntds-dit-file-part-1"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)("a",{id:"a3",children:"[3]"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/de-de/windows/win32/api/minwinbase/ns-minwinbase-filetime",children:"https://learn.microsoft.com/de-de/windows/win32/api/minwinbase/ns-minwinbase-filetime"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)("a",{id:"a4",children:"[4]"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/de-de/windows/win32/adschema/a-accountexpires",children:"https://learn.microsoft.com/de-de/windows/win32/adschema/a-accountexpires"})})]})]})]})]})}function o(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(a,{...e})}):a(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>d,x:()=>c});var s=i(6540);const r={},t=s.createContext(r);function d(e){const n=s.useContext(t);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:d(e.components),s.createElement(t.Provider,{value:n},e.children)}}}]);